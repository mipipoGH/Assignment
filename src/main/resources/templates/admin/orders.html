<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Manage Orders</title>

    <!-- Bootstrap CSS nếu chưa có -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        .status-select {
            min-width: 150px;
        }
        .table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        .badge {
            font-size: 0.75em;
        }
    </style>
</head>
<body>

        <h2>Manage Orders</h2>

        <!-- Success Message -->
        <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle me-2"></i>
            <span th:text="${successMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>

        <!-- Error Message -->
        <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <span th:text="${errorMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>

        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-bar-chart me-2"></i>Thống kê trạng thái đơn hàng
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-2" th:each="stat : ${statusStats}">
                                <div class="text-center">
                                    <div class="h4 mb-0" th:text="${stat.value}">0</div>
                                    <small class="text-muted" th:text="${stat.key}">Trạng thái</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <a class="btn btn-primary mb-3" th:href="@{/admin/orders/create}">
            <i class="bi bi-plus-circle me-2"></i>Thêm hóa đơn
        </a>

        <table class="table table-bordered table-striped">
            <thead>
            <tr>
                <th>Mã hóa đơn</th>
                <th>Khách hàng</th>
                <th>Nhân viên</th>
                <th>Ngày lập</th>
                <th>Trạng thái</th>
                <th>Tổng tiền</th>
                <th>Chuyển trạng thái</th>
                <th>Thao tác</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="o : ${orders}">
                <td th:text="${o.maHD}">HD01</td>
                <td th:text="${o.khachHang != null ? o.khachHang.hoTen : 'Không có'}">Nguyễn Văn A</td>
                <td th:text="${o.nhanVien != null ? o.nhanVien.hoTen : 'Không có'}">Trần Thị B</td>
                <td th:text="${#temporals.format(o.ngayLap, 'dd/MM/yyyy')}">22/10/2025</td>
                <td>
                    <span class="badge" 
                          th:class="${o.trangThai == 'Chờ duyệt' ? 'badge bg-warning' : 
                                     o.trangThai == 'Đang giao' ? 'badge bg-primary' :
                                     o.trangThai == 'Hoàn tất' ? 'badge bg-success' : 'badge bg-light'}"
                          th:text="${o.trangThai}">Chờ duyệt</span>
                </td>
                <td th:text="${#numbers.formatDecimal(o.tongTien, 0, 'COMMA', 2, 'POINT')} + ' ₫'">0 ₫</td>
                <td>
                    <form th:action="@{/admin/orders/change-status}" method="post" class="d-inline">
                        <input type="hidden" name="maHD" th:value="${o.maHD}">
                        <select name="trangThai" class="form-select form-select-sm status-select" 
                                onchange="confirmStatusChange(this)" th:value="${o.trangThai}">
                            <option value="Chờ duyệt" th:selected="${o.trangThai == 'Chờ duyệt'}">Chờ duyệt</option>
                            <option value="Đang giao" th:selected="${o.trangThai == 'Đang giao'}">Đang giao</option>
                            <option value="Hoàn tất" th:selected="${o.trangThai == 'Hoàn tất'}">Hoàn tất</option>
                        </select>
                    </form>
                </td>
                <td>
                    <a th:href="@{'/admin/orders/edit/' + ${o.maHD}}" class="btn btn-sm btn-warning">
                        <i class="bi bi-pencil"></i> Sửa
                    </a>
                    <a th:href="@{'/admin/orders/delete/' + ${o.maHD}}" class="btn btn-sm btn-danger"
                       onclick="return confirm('Bạn có chắc muốn xóa hóa đơn này?')">
                        <i class="bi bi-trash"></i> Xóa
                    </a>
                </td>
            </tr>
            </tbody>
        </table>



<!-- Bootstrap JS nếu cần -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
function confirmStatusChange(selectElement) {
    const newStatus = selectElement.value;
    const orderId = selectElement.form.querySelector('input[name="maHD"]').value;
    
    if (confirm(`Bạn có chắc muốn chuyển trạng thái đơn hàng ${orderId} thành "${newStatus}"?`)) {
        selectElement.form.submit();
    } else {
        // Reset về giá trị cũ nếu user hủy
        selectElement.selectedIndex = selectElement.getAttribute('data-original-index') || 0;
    }
}

// Lưu index ban đầu của các select
document.addEventListener('DOMContentLoaded', function() {
    const selects = document.querySelectorAll('.status-select');
    selects.forEach(select => {
        select.setAttribute('data-original-index', select.selectedIndex);
    });
});
</script>

</body>
</html>
